<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNDERTALE</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <canvas id="gameCanvas" width="640" height="480"></canvas>
  <script type="module">
    import roomSize from '/imports/assets/roomSize.js'

    roomSize.width = 740;  // room width in px
    roomSize.height = 240; // room height in px

  </script>
  <script src="/imports/howler.js"></script>
  <script type="module">
    import { control_update, input_update, keyboard, _key_state } from "/imports/input.js";
    import { instance_create, instances, secondFont, draw_text, draw_tile, audio_resume_sound } from "/imports/assets/gamemakerFunctions.js"
    import { view_current, view_xview, view_yview, updateCamera } from "/imports/view.js"
    import { bg_ruinsplaceholder, bg_ruinsplaceholder2, bg_ruinseasynam1, bg_ruinseasynam2, bg_ruinseasynam3 } from "/imports/assets.js";
    import { loadCurrentSong } from "/imports/assets/loadSong.js"
    import global from "/imports/assets/global.js"
    import * as obj_fakewateropenr from '/obj/fakewateropenr/index.js'
    import * as obj_fakewateropenl from '/obj/fakewateropenl/index.js'
    import * as obj_fakewaterl from '/obj/fakewaterl/index.js'
    import * as obj_fakewaterr from '/obj/fakewaterr/index.js'
    import * as obj_fakewatershadowl from '/obj/fakewatershadowl/index.js'
    import * as obj_fakewatershadowr from '/obj/fakewatershadowr/index.js'
    import * as obj_spikes_room from '/obj/spikes_room/index.js'
    import * as obj_readable_sign1 from '/obj/readable_sign1/index.js'
    import * as obj_toroverworld4 from '/obj/toroverworld4/index.js'
    import * as obj_plotwall1 from '/obj/plotwall1/index.js'
    import * as obj_torieltrigger2 from '/obj/torieltrigger2/index.js'
    import * as obj_torinteractable1 from '/obj/torinteractable1/index.js'
    import * as obj_npc_marker from '/obj/npc_marker/index.js'
    import * as obj_plotswitch1 from '/obj/plotswitch1/index.js'
    import * as obj_plotswitch2 from '/obj/plotswitch2/index.js'
    import * as obj_torinteractable2 from '/obj/torinteractable2/index.js'
    import * as obj_readable_switch1 from '/obj/readable_switch1/index.js'
    import * as obj_switchadvice1 from '/obj/switchadvice1/index.js'
    import * as obj_switchadvice2 from '/obj/switchadvice2/index.js'
    import * as obj_mainchara from '/obj/mainchara/index.js'
    import * as obj_overworldcontroller from '/obj/overworldcontroller/index.js'
    import * as obj_doorB from '/obj/doorB/index.js'
    import * as obj_markerA from '/obj/markerA/index.js'
    import * as obj_doorA from '/obj/doorA/index.js'
    import * as obj_markerB from '/obj/markerB/index.js'
    import * as obj_solidlong from '/obj/solidlong/index.js'
    import * as obj_solidtall from '/obj/solidtall/index.js'
    import * as obj_solidsmall from '/obj/solidsmall/index.js';
    import * as obj_readable_room1 from '/obj/readable_room1/index.js'
    import * as screenUpdater from '/obj/screen/index.js'

    const allInstances = [];

    loadCurrentSong("currentsong", global.playing1)
    loadCurrentSong("currentsong2", global.playing2)

    screenUpdater.create()
    global.newRoom = ["fakewateropenr", "fakewateropenl", "fakewaterr", "fakewaterl", "fakewatershadowl", "fakewateershadowr", "spikes_room", "readable_sign1", "toroverworld4", "plotwall1", "torieltrigger2", "npc_marker", "plotswitch1", "plotswitch2", "torinteractable2", "torinteractable1", "readable_switch1", "switchadvice1", "switchadvice2", "mainchara", "overworldcontroller", "doorB", "doorA", "markerB", "solidlong", "solidtall", "solidsmall", "readable_room1"];
    instance_create(260, 60, obj_fakewateropenr);
    instance_create(500, 60, obj_fakewateropenr);
    instance_create(240, 60, obj_fakewateropenl);
    instance_create(480, 60, obj_fakewateropenl);
    instance_create(480, 200, obj_fakewaterl);
    instance_create(480, 120, obj_fakewaterl);
    instance_create(480, 100, obj_fakewaterl);
    instance_create(240, 200, obj_fakewaterl);
    instance_create(240, 120, obj_fakewaterl);
    instance_create(240, 100, obj_fakewaterl);
    instance_create(500, 200, obj_fakewaterr);
    instance_create(500, 120, obj_fakewaterr);
    instance_create(500, 100, obj_fakewaterr);
    instance_create(260, 200, obj_fakewaterr);
    instance_create(260, 120, obj_fakewaterr);
    instance_create(260, 100, obj_fakewaterr);
    instance_create(480, 180, obj_fakewatershadowl);
    instance_create(240, 180, obj_fakewatershadowl);
    instance_create(260, 180, obj_fakewatershadowr);
    instance_create(500, 180, obj_fakewatershadowr);
    instance_create(700, 140, obj_spikes_room);
    instance_create(700, 160, obj_spikes_room);
    instance_create(120, 218, obj_doorB);
    instance_create(140, 218, obj_doorB);
    instance_create(130, 187, obj_markerA);
    instance_create(20, 0, obj_solidtall);
    instance_create(720, 0, obj_solidtall);
    instance_create(240, 200, obj_solidsmall);
    instance_create(240, 180, obj_solidsmall);
    instance_create(260, 180, obj_solidsmall);
    instance_create(260, 200, obj_solidsmall);
    instance_create(240, 120, obj_solidsmall);
    instance_create(240, 100, obj_solidsmall);
    instance_create(240, 80, obj_solidsmall);
    instance_create(260, 80, obj_solidsmall);
    instance_create(260, 100, obj_solidsmall);
    instance_create(260, 120, obj_solidsmall);
    instance_create(700, 120, obj_solidsmall);
    instance_create(700, 100, obj_solidsmall);
    instance_create(700, 80, obj_solidsmall);
    instance_create(700, 180, obj_solidsmall);
    instance_create(700, 200, obj_solidsmall);
    instance_create(500, 200, obj_solidsmall);
    instance_create(500, 180, obj_solidsmall);
    instance_create(480, 180, obj_solidsmall);
    instance_create(480, 200, obj_solidsmall);
    instance_create(500, 120, obj_solidsmall);
    instance_create(500, 100, obj_solidsmall);
    instance_create(500, 80, obj_solidsmall);
    instance_create(480, 80, obj_solidsmall);
    instance_create(480, 100, obj_solidsmall);
    instance_create(480, 120, obj_solidsmall);
    instance_create(718, 140, obj_doorA);
    instance_create(718, 160, obj_doorA);
    instance_create(130, 120, obj_readable_sign1);
    instance_create(697, 140, obj_markerB);
    instance_create(155, 110, obj_toroverworld4);
    instance_create(480, 30, obj_plotwall1);
    instance_create(704, 60, obj_torieltrigger2);
    instance_create(450, 110, obj_torinteractable1);
    instance_create(720, 150, obj_npc_marker);
    instance_create(392, 60, obj_plotswitch1);
    instance_create(670, 110, obj_torinteractable2);
    instance_create(592, 60, obj_plotswitch2);
    instance_create(100, 60, obj_readable_room1);
    instance_create(630, 60, obj_readable_switch1);
    instance_create(560, 40, obj_switchadvice2);
    instance_create(357, 40, obj_switchadvice1);
    instance_create(20, 60, obj_solidlong);
    instance_create(20, 220, obj_solidlong);
    instance_create(632, 140, obj_mainchara);
    instance_create(20, 20, obj_overworldcontroller);
    if (global.newRoom[0] && global.execStart) {
      for (const [_, list] of instances.entries()) {
        for (const instance of list) {
          global.newRoom.forEach((name) => {
            if (instance.name === name) {
              instance.roomStart?.call(instance);
            }
          });
        }
      }
    }
    global.newRoom = [];

    function draw_tiles() {
      const T0 = { tile_index: 0, hflip: false, vflip: false };
      const T1 = { tile_index: 1, hflip: false, vflip: false };
      const T2 = { tile_index: 2, hflip: false, vflip: false };
      const T3 = { tile_index: 3, hflip: false, vflip: false };
      const T5 = { tile_index: 5, hflip: false, vflip: false };
      const T6 = { tile_index: 6, hflip: false, vflip: false };
      const T7 = { tile_index: 7, hflip: false, vflip: false };
      const T9 = { tile_index: 9, hflip: false, vflip: false };
      const T10 = { tile_index: 10, hflip: false, vflip: false };
      const T11 = { tile_index: 11, hflip: false, vflip: false };
      const T12 = { tile_index: 12, hflip: false, vflip: false };
      const T13 = { tile_index: 13, hflip: false, vflip: false };
      const T14 = { tile_index: 14, hflip: false, vflip: false };
      const T15 = { tile_index: 15, hflip: false, vflip: false };
      const T20 = { tile_index: 20, hflip: false, vflip: false };
      const T21 = { tile_index: 21, hflip: false, vflip: false };
      const T22 = { tile_index: 22, hflip: false, vflip: false };
      const T29 = { tile_index: 29, hflip: false, vflip: false };
      const T30 = { tile_index: 30, hflip: false, vflip: false };
      const T35 = { tile_index: 35, hflip: false, vflip: false };
      const T37 = { tile_index: 37, hflip: false, vflip: false };
      const T38 = { tile_index: 38, hflip: false, vflip: false };
      const T52 = { tile_index: 52, hflip: false, vflip: false };
      const T72 = { tile_index: 72, hflip: false, vflip: false };
      const T73 = { tile_index: 73, hflip: false, vflip: false };
      const T86 = { tile_index: 86, hflip: false, vflip: false };
      const T92 = { tile_index: 92, hflip: false, vflip: false };
      const T93 = { tile_index: 93, hflip: false, vflip: false };
      const T94 = { tile_index: 94, hflip: false, vflip: false };
      const T95 = { tile_index: 95, hflip: false, vflip: false };
      const T119 = { tile_index: 119, hflip: false, vflip: false };

      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 160, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 180, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 180, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 140);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 140);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 140);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 160);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 160);
      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 160);
      draw_tile(bg_ruinsplaceholder, T0, 0, 180, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 160, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 140, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 120, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 120, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 180, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 160, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 140, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 200, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 200, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 200, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 200, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 100);
      draw_tile(bg_ruinsplaceholder, T5, 0, 120, 220);
      draw_tile(bg_ruinsplaceholder, T5, 0, 140, 220);
      draw_tile(bg_ruinsplaceholder, T5, 0, 140, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 160, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 180, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 200, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 220, 140);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 380, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 360, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 360, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 380, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 400, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 400, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 420, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 420, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 420, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 420, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 420, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 440, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 440, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 440, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 440, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 440, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 460, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 460, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 460, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 460, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 460, 200);
      draw_tile(bg_ruinsplaceholder, T5, 0, 300, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 440, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 460, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 460, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 440, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 420, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 400, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 380, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 320, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 280, 160);
      draw_tile(bg_ruinsplaceholder, T0, 0, 520, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 520, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 520, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 520, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 520, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 540, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 560, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 580, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 600, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 620, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 640, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 640, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 640, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 620, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 600, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 560, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 560, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 540, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 540, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 540, 120);
      draw_tile(bg_ruinsplaceholder, T5, 0, 540, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 520, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 560, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 580, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 540, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 520, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 560, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 580, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 600, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 620, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 600, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 620, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 640, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 660, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 680, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 640, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 660, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 680, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 720, 140);
      draw_tile(bg_ruinsplaceholder, T5, 0, 720, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 460, 160);
      draw_tile(bg_ruinsplaceholder, T5, 0, 460, 140);
      draw_tile(bg_ruinsplaceholder, T0, 0, 620, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 620, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 600, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 640, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 660, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 660, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 660, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 680, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 680, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 680, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 540, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 560, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 580, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 600, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 620, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 640, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 660, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 680, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 660, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 680, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 280, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 280, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 280, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 300, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 320, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 340, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 220, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 220, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 280, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 280, 200);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 100, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 120, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 140, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 160, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 180, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 200, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 220, 80);
      draw_tile(bg_ruinsplaceholder, T0, 0, 220, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 220, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 140);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 80, 100);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 60, 120);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 160);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 180);
      draw_tile(bg_ruinsplaceholder, T0, 0, 40, 200);
      draw_tile(bg_ruinsplaceholder2, T20, 0, 120, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 120, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 120, 180);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 120, 200);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 140, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 140, 180);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 140, 200);
      draw_tile(bg_ruinsplaceholder2, T6, 0, 160, 180);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 160, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 180, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 200, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 220, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 280, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 300, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 320, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 340, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 340, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 360, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 360, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 380, 160);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 400, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 420, 140);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 380, 120);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 380, 100);
      draw_tile(bg_ruinsplaceholder2, T14, 0, 400, 120);
      draw_tile(bg_ruinsplaceholder2, T15, 0, 360, 120);
      draw_tile(bg_ruinsplaceholder2, T35, 0, 380, 80);
      draw_tile(bg_ruinsplaceholder2, T0, 0, 360, 80);
      draw_tile(bg_ruinsplaceholder2, T0, 0, 360, 100);
      draw_tile(bg_ruinsplaceholder2, T0, 0, 400, 80);
      draw_tile(bg_ruinsplaceholder2, T0, 0, 400, 100);
      draw_tile(bg_ruinsplaceholder2, T15, 0, 560, 120);
      draw_tile(bg_ruinsplaceholder2, T14, 0, 600, 120);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 580, 120);
      draw_tile(bg_ruinsplaceholder2, T9, 0, 580, 100);
      draw_tile(bg_ruinsplaceholder2, T35, 0, 580, 80);
      draw_tile(bg_ruinseasynam1, T10, 0, 40, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 60, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 80, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 100, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 120, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 140, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 160, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 180, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 200, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 220, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 280, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 300, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 320, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 340, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 360, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 380, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 400, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 420, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 440, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 460, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 520, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 540, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 560, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 580, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 600, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 620, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 640, 60);
      draw_tile(bg_ruinseasynam1, T10, 0, 660, 60);
      draw_tile(bg_ruinseasynam1, T2, 0, 40, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 60, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 80, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 100, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 120, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 140, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 160, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 180, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 200, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 220, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 280, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 300, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 320, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 340, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 360, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 380, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 400, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 420, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 440, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 460, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 520, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 540, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 560, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 580, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 600, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 620, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 640, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 660, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 40, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 60, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 80, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 100, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 120, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 140, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 160, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 180, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 200, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 220, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 280, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 300, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 320, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 340, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 360, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 380, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 400, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 420, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 440, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 460, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 520, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 540, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 560, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 580, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 600, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 620, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 640, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 660, 20);
      draw_tile(bg_ruinseasynam1, T11, 0, 680, 60);
      draw_tile(bg_ruinseasynam1, T3, 0, 680, 40);
      draw_tile(bg_ruinseasynam1, T3, 0, 680, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 240, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 240, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 260, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 260, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 480, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 480, 20);
      draw_tile(bg_ruinseasynam1, T2, 0, 500, 40);
      draw_tile(bg_ruinseasynam1, T2, 0, 500, 20);
      draw_tile(bg_ruinseasynam1, T7, 0, 100, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 80, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 60, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 40, 220);
      draw_tile(bg_ruinseasynam1, T37, 0, 20, 220);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 200);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 180);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 160);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 140);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 120);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 100);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 80);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 60);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 40);
      draw_tile(bg_ruinseasynam1, T15, 0, 20, 20);
      draw_tile(bg_ruinseasynam1, T29, 0, 20, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 40, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 60, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 80, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 100, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 120, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 140, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 160, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 180, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 200, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 220, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 240, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 260, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 280, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 300, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 320, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 340, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 360, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 380, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 400, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 420, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 440, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 460, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 480, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 500, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 520, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 540, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 560, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 580, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 600, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 620, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 640, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 660, 0);
      draw_tile(bg_ruinseasynam1, T22, 0, 680, 0);
      draw_tile(bg_ruinseasynam1, T30, 0, 700, 0);
      draw_tile(bg_ruinseasynam1, T13, 0, 700, 20);
      draw_tile(bg_ruinseasynam1, T13, 0, 700, 40);
      draw_tile(bg_ruinseasynam1, T21, 0, 700, 60);
      draw_tile(bg_ruinseasynam1, T22, 0, 720, 60);
      draw_tile(bg_ruinseasynam1, T2, 0, 720, 80);
      draw_tile(bg_ruinseasynam1, T2, 0, 720, 100);
      draw_tile(bg_ruinseasynam1, T10, 0, 720, 120);
      draw_tile(bg_ruinseasynam1, T1, 0, 700, 80);
      draw_tile(bg_ruinseasynam1, T1, 0, 700, 100);
      draw_tile(bg_ruinseasynam1, T9, 0, 700, 120);
      draw_tile(bg_ruinseasynam1, T6, 0, 720, 180);
      draw_tile(bg_ruinseasynam1, T5, 0, 700, 180);
      draw_tile(bg_ruinseasynam1, T13, 0, 700, 200);
      draw_tile(bg_ruinseasynam1, T38, 0, 700, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 680, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 660, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 640, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 620, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 600, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 580, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 560, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 540, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 520, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 500, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 480, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 460, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 440, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 420, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 400, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 380, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 360, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 340, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 320, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 300, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 280, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 260, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 240, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 220, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 200, 220);
      draw_tile(bg_ruinseasynam1, T6, 0, 180, 220);
      draw_tile(bg_ruinseasynam1, T5, 0, 160, 220);
      draw_tile(bg_ruinseasynam2, T52, 0, 100, 40);
      draw_tile(bg_ruinseasynam3, T86, 0, 140, 20);
      draw_tile(bg_ruinseasynam3, T86, 0, 140, 40);
      draw_tile(bg_ruinseasynam3, T86, 0, 140, 60);
      draw_tile(bg_ruinseasynam3, T86, 0, 200, 20);
      draw_tile(bg_ruinseasynam3, T86, 0, 200, 40);
      draw_tile(bg_ruinseasynam3, T86, 0, 200, 60);
      draw_tile(bg_ruinseasynam3, T92, 0, 300, 20);
      draw_tile(bg_ruinseasynam3, T92, 0, 300, 40);
      draw_tile(bg_ruinseasynam3, T92, 0, 300, 60);
      draw_tile(bg_ruinseasynam3, T95, 0, 320, 20);
      draw_tile(bg_ruinseasynam3, T95, 0, 320, 40);
      draw_tile(bg_ruinseasynam3, T95, 0, 320, 60);
      draw_tile(bg_ruinseasynam3, T86, 0, 440, 20);
      draw_tile(bg_ruinseasynam3, T86, 0, 440, 40);
      draw_tile(bg_ruinseasynam3, T86, 0, 440, 60);
      draw_tile(bg_ruinseasynam3, T86, 0, 540, 20);
      draw_tile(bg_ruinseasynam3, T86, 0, 540, 40);
      draw_tile(bg_ruinseasynam3, T86, 0, 540, 60);
      draw_tile(bg_ruinseasynam3, T92, 0, 640, 20);
      draw_tile(bg_ruinseasynam3, T92, 0, 640, 40);
      draw_tile(bg_ruinseasynam3, T92, 0, 640, 60);
      draw_tile(bg_ruinsplaceholder, T12, 0, 660, 20);
      draw_tile(bg_ruinsplaceholder, T12, 0, 660, 40);
      draw_tile(bg_ruinseasynam3, T93, 0, 660, 20);
      draw_tile(bg_ruinseasynam3, T93, 0, 660, 40);
      draw_tile(bg_ruinseasynam3, T94, 0, 660, 60);
      draw_tile(bg_ruinseasynam3, T95, 0, 680, 20);
      draw_tile(bg_ruinseasynam3, T95, 0, 680, 40);
      draw_tile(bg_ruinseasynam3, T95, 0, 680, 60);
      draw_tile(bg_ruinseasynam3, T119, 0, 700, 140);
      draw_tile(bg_ruinseasynam3, T119, 0, 700, 160);
      draw_tile(bg_ruinseasynam3, T72, 0, 500, 140);
      draw_tile(bg_ruinseasynam3, T73, 0, 500, 160);
      draw_tile(bg_ruinseasynam3, T72, 0, 480, 140);
      draw_tile(bg_ruinseasynam3, T73, 0, 480, 160);
      draw_tile(bg_ruinseasynam3, T72, 0, 260, 140);
      draw_tile(bg_ruinseasynam3, T73, 0, 260, 160);
      draw_tile(bg_ruinseasynam3, T72, 0, 240, 140);
      draw_tile(bg_ruinseasynam3, T73, 0, 240, 160);
    }

    if (global.room_persistent === window.location.href) {
      const save = global._roomSaves?.[window.location.href];
      if (save) {
        for (const { objName, data } of save) {
          // Try to find the object by name in current instances map keys
          let obj = null;
          for (const candidates of instances.values()) {
            for (const inst of candidates) {
              if (inst.name === objName) {
                obj = inst;
                obj.saved = true;
                inst.saved = false;
                break;
              }
            }
          }

          if (!obj) {
            console.warn(`Object with name "${objName}" not found, skipping instance`);
            continue;
          }
          const instance = obj._object?.create?.();
          if (!instance) {
            console.error(`instance ${objName}.create() is invalid or null`); continue;
          }
          instance._object = obj._object;
          Object.defineProperties(instance, Object.getOwnPropertyDescriptors(data));
          Object.defineProperties(instance, Object.getOwnPropertyDescriptors(instance._object));

          instance.startx = instance.x;
          instance.starty = instance.y;
          instance.xstart = instance.x;
          instance.ystart = instance.y;

          if (!instances.get(obj._object)[0].saved) instances.set(obj._object, []);

          instances.get(obj._object).push(instance);

          obj.roomStart?.call(instance);
        };
      }
    }

    function filterDestroyed() {
      for (const [obj, instanceList] of instances) {
        // Remove all destroyed instances
        for (let i = instanceList.length - 1; i >= 0; i--) {
          if (instanceList[i]._destroyed) {
            instanceList.splice(i, 1);
          }
        }
      }
    }

    // gameloop DO NOT EDIT VARIABLES UNLESS NECESSARY (eg. changing fps in this room for some reason)
    // IMPORTANT: replace "obj_objectname" with the object name (eg. obj_mainchara) and import it from /obj/objectname/index.js above
    const FPS = 30;
    const FRAME_DURATION = 1000 / FPS;
    let lastFrameTime = 0;
    let fpsCounter = 0;
    let lastFpsUpdate = performance.now();
    let currentFps = 0;
    function game_loop(currentTime) {
      const elapsed = currentTime - lastFrameTime;

      allInstances.length = 0;

      if (elapsed >= FRAME_DURATION) {
        lastFrameTime = currentTime;

        fpsCounter++;

        const now = currentTime;
        if (now - lastFpsUpdate >= 1000) {
          currentFps = fpsCounter;
          fpsCounter = 0;
          lastFpsUpdate = now;
        }

        screenUpdater.beginStep();
        control_update();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.beginStep?.call(instance);
          }
        }
        filterDestroyed();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.updateAlarms?.call(instance);
          }
        }
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.step?.call(instance);
          }
        }
        filterDestroyed();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.followPath?.call(instance);
          }
        }
        screenUpdater.endStep();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.endStep?.call(instance);
          }
        }
        filterDestroyed();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            allInstances.push({ obj, instance });
          }
        }

        allInstances.sort((a, b) => b.instance.depth - a.instance.depth);

        draw_tiles();

        for (const { obj, instance } of allInstances) {
          if (!obj.draw) obj.updateSprite?.call(instance);
          obj.draw?.call(instance);
        }
        filterDestroyed();

        if (global.debug === 1 && secondFont) {
          draw_text(15 + view_xview[view_current], 15 + view_yview[view_current], currentFps, 1);
        }

        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.updateGamemakerFunctions?.call(instance);
          }
        }

        updateCamera(instances.get(obj_mainchara)[0]) // replace obj_objectname with your centered object or instances.get(...)[0] with {x: 0, y: 0} for no screen centering
        screenUpdater.updateScreen();

        input_update();

        if (global.roomEnd && !global.eventDone) {
          global.eventDone = true;
          for (const [obj, instanceList] of instances) {
            for (const instance of instanceList) {
              obj.roomEnd?.call(instance);
            }
          }
        }

        if (global.roomEnd && global.eventDone && global.nextRoom !== null && "https://undertale.defautluser0.xyz" + global.nextRoom !== window.location.href) {
          if (global.room_persistent === window.location.href) {
            const save = [];

            for (const [obj, list] of instances.entries()) {
              const objName = list[0]?.name;
              if (!objName) continue;

              for (const inst of list) {
                const data = {};
                for (const key in inst) {
                  if (key !== "_object" && typeof inst[key] !== "function") {
                    data[key] = inst[key];
                  }
                }
                save.push({
                  objName,
                  data
                });
              }
            }

            global._roomSaves = global._roomSaves || {};
            global._roomSaves[window.location.href] = save;
          }
          global.eventDone = false;
          global.roomEnd = false;
          let nextRoom = global.nextRoom
          global.nextRoom = null;

          function extractNameFromSrc(src) {
            // src expected: "/imports/assets/mus/xxx.ogg" or "/imports/assets/snd/yyy.ogg"
            const parts = src.split('/');
            if (parts.length < 4) return null; // safeguard

            const folder = parts[3]; // 'mus' or 'snd'
            const filename = parts[4]?.split('.')[0]; // 'xxx' or 'yyy'
            if (!folder || !filename) return null;

            return `${folder}_${filename}`;
          }

          try {
            localStorage.setItem("global", JSON.stringify(global));
          } catch (_) {
            if (global.currentsong !== -1) {
              let currentsong = global.currentsong;
              global.currentsong = {
                name: extractNameFromSrc(currentsong._src) ?? "unknown",
                rate: currentsong.rate?.() ?? 1,
                volume: currentsong.volume?.() ?? 1,
                paused: !global.playing1 ?? false,
                pos: currentsong.seek?.() ?? 0,
                loop: currentsong.loop?.() ?? false,
              };
              localStorage.setItem("global", JSON.stringify(global));
              global.currentsong = currentsong;
            }
            if (global.currentsong2 !== -1) {
              let currentsong2 = global.currentsong2;
              global.currentsong2 = {
                name: extractNameFromSrc(currentsong2._src) ?? "unknown",
                rate: currentsong2.rate?.() ?? 1,
                volume: currentsong2.volume?.() ?? 1,
                paused: !global.playing2 ?? false,
                pos: currentsong2.seek?.() ?? 0,
                loop: currentsong2.loop?.() ?? false,
              };
              localStorage.setItem("global", JSON.stringify(global));
              global.currentsong2 = currentsong2;
            }
          }
          window.location.href = nextRoom;
        }
      }

      requestAnimationFrame(game_loop);
    }

    window.addEventListener("keydown", e => {
      keyboard[e.code] = true;
      _key_state[e.code] = true;
    });
    window.addEventListener("keyup", e => {
      keyboard[e.code] = false;
      _key_state[e.code] = false;
    });

    // room code (object positioning and such) goes here

    // starts the game loop once everything has been defined
    window.addEventListener('load', () => {
      requestAnimationFrame(game_loop);
    })
  </script>
</body>

</html>