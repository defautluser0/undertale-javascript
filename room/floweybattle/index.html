<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNDERTALE</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <canvas id="gameCanvas" width="640" height="480"></canvas>
  <script type="module">
    import roomSize from '/imports/assets/roomSize.js'

    roomSize.width = 640;  // room width in px
    roomSize.height = 480; // room height in px

  </script>
  <script src="/imports/howler.js"></script>
  <script type="module">
    import { control_update, input_update, keyboard, _key_state } from "/imports/input.js";
		import { instance_create, instances, secondFont, draw_text } from "/imports/assets/gamemakerFunctions.js"
    import { view_current, view_xview, view_yview, updateCamera } from "/imports/view.js"
    import { loadCurrentSong } from "/imports/assets/loadSong.js";
    import roomSize from '/imports/assets/roomSize.js'
		import global from "/imports/assets/global.js"
    import * as obj_floweydraw from '/obj/floweydraw/index.js'
    import * as obj_floweybattle1 from '/obj/floweybattle1/index.js'
    import * as obj_fakeheart from '/obj/fakeheart/index.js'
    import * as obj_lborder from '/obj/lborder/index.js'
    import * as obj_dborder from '/obj/dborder/index.js'
    import * as obj_uborder from '/obj/uborder/index.js'
    import * as obj_rborder from '/obj/rborder/index.js'
    import * as obj_battlefader from '/obj/battlefader/index.js'
		import * as screenUpdater from '/obj/screen/index.js'

		const allInstances = [];

    loadCurrentSong("currentsong")
    loadCurrentSong("currentsong2")

    screenUpdater.create()
    instance_create(21, 20, obj_floweydraw);
    instance_create(281, 134, obj_floweybattle1);
    instance_create(308, 312, obj_fakeheart);
    instance_create(220, 380, obj_lborder);
    instance_create(220, 380, obj_dborder);
    instance_create(220, 255, obj_uborder);
    instance_create(405, 380, obj_rborder);
    instance_create(0, 0, obj_battlefader);

    // gameloop DO NOT EDIT VARIABLES UNLESS NECESSARY (eg. changing fps in this room for some reason)
    // IMPORTANT: replace "obj_objectname" with the object name (eg. obj_mainchara) and import it from /obj/objectname/index.js above
    const FPS = 30;
    const FRAME_DURATION = 1000 / FPS;
    let lastFrameTime = 0;
    let fpsCounter = 0;
    let lastFpsUpdate = performance.now();
    let currentFps = 0;
    function game_loop(currentTime) {
      const elapsed = currentTime - lastFrameTime;

      allInstances.length = 0;

      if (elapsed >= FRAME_DURATION) {
        lastFrameTime = currentTime;

        fpsCounter++;

        const now = currentTime;
        if (now - lastFpsUpdate >= 1000) {
          currentFps = fpsCounter;
          fpsCounter = 0;
          lastFpsUpdate = now;
        }
        
        control_update();
        screenUpdater.beginStep();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.beginStep?.call(instance);
          }
        }
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.updateAlarms?.call(instance);
          }
        }
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.step?.call(instance);
          }
        }
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            if (instance.x > roomSize.width || instance.x < 0 || instance.y > roomSize.height || instance.y < 0) {
              obj.outsideRoom?.call(instance);
            }
          }
        }
        screenUpdater.endStep();
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.endStep?.call(instance);
          }
        }
        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            allInstances.push({ obj, instance });
          }
        }

        allInstances.sort((a, b) => b.instance.depth - a.instance.depth);

        for (const { obj,  instance } of allInstances) {
          obj.updateSprite?.call(instance);
          obj.draw?.call(instance);
        }

        if (global.debug === 1 && secondFont) {
          draw_text(15 + view_xview[view_current], 15 + view_yview[view_current], currentFps, 1);
        }

        for (const [obj, instanceList] of instances) {
          for (const instance of instanceList) {
            obj.updateGamemakerFunctions?.call(instance);
          }
        }

        updateCamera({x:0,y:0}) // replace obj_objectname with your centered object or instances.get(...)[0] with {x: 0, y: 0} for no screen centering
        screenUpdater.updateScreen();

        input_update();

        if (global.roomEnd && !global.eventDone) {
          global.eventDone = true;
          for (const [obj, instanceList] of instances) {
            for (const instance of instanceList) {
              obj.roomEnd?.call(instance);
            }
          }
        }

        if (global.roomEnd && global.eventDone && global.nextRoom !== null) {
          global.eventDone = false;
          let nextRoom = global.nextRoom;
          global.nextRoom = null;

          function extractNameFromSrc(src) {
            // src expected: "/imports/assets/mus/xxx.ogg" or "/imports/assets/snd/yyy.ogg"
            const parts = src.split('/');
            if (parts.length < 4) return null; // safeguard

            const folder = parts[3]; // 'mus' or 'snd'
            const filename = parts[4]?.split('.')[0]; // 'xxx' or 'yyy'
            if (!folder || !filename) return null;

            return `${folder}_${filename}`;
          }
          
          try {
            localStorage.setItem("global", JSON.stringify(global));
          } catch(_) {
            if (global.currentsong !== -1) {
              let currentsong = global.currentsong;
              global.currentsong = {
                name: extractNameFromSrc(currentsong._src) ?? "unknown",
                rate: currentsong.rate?.() ?? 1,
                volume: currentsong.volume?.() ?? 1,
                paused: !currentsong.playing?.() ?? false,
                pos: currentsong.seek?.() ?? 0,
                loop: currentsong.loop?.() ?? false,
              };
              localStorage.setItem("global", JSON.stringify(global));
              global.currentsong = currentsong;
            }
            if (global.currentsong2 !== -1) {
              let currentsong2 = global.currentsong2;
              global.currentsong2 = {
                name: extractNameFromSrc(currentsong2._src) ?? "unknown",
                rate: currentsong2.rate?.() ?? 1,
                volume: currentsong2.volume?.() ?? 1,
                paused: !currentsong2.playing?.() ?? false,
                pos: currentsong2.seek?.() ?? 0,
                loop: currentsong2.loop?.() ?? false,
              };
              localStorage.setItem("global", JSON.stringify(global));
              global.currentsong2 = currentsong2;
            }
          }
          window.location.href = nextRoom;
        }
      }

      requestAnimationFrame(game_loop);
    }

		window.addEventListener("keydown", e => {
      keyboard[e.code] = true;
      _key_state[e.code] = true;
    });
    window.addEventListener("keyup", e => {
      keyboard[e.code] = false;
      _key_state[e.code] = false;
    });

    // room code (object positioning and such) goes here

    // starts the game loop once everything has been defined
    window.addEventListener('load', () => {
      requestAnimationFrame(game_loop);
    })
  </script>
</body>

</html>